#!/usr/bin/env bash
set -euo pipefail

./scripts/githooks/pre-commit-env-check

# Gather staged files
STAGED="$(git diff --cached --name-only)"

# Hard blocks
BLOCK_PATTERNS=(
  '^\.env$'
  '^sandbox/home/'
  'terraform\.tfstate'
  '\.terraform/'
)

for p in "${BLOCK_PATTERNS[@]}"; do
  if echo "$STAGED" | grep -E "$p" >/dev/null 2>&1; then
    echo "❌ Pre-commit blocked: staged files include forbidden pattern: $p"
    echo "Staged files:"
    echo "$STAGED"
    exit 1
  fi
done

# Secret sniff (exclude docs/ and .env.example; allow placeholders)
# Only flag likely secret ASSIGNMENTS (not normal prose mentioning "token", etc.)
if git diff --cached --name-only \
  | grep -Ev '^(docs/|scripts/githooks/|\.env\.example$|README\.md$)' \
  | xargs -I{} git diff --cached {} \
  | grep -Ein '(BEGIN PRIVATE KEY|API[_-]?KEY\s*=|SECRET\s*=|TOKEN\s*=|Authorization:\s*Bearer\s+)' \
  | grep -vE '=changeme|=<.*>' \
  >/dev/null 2>&1; then
  echo "❌ Pre-commit blocked: potential secret detected outside docs/ or .env.example."
  echo "   Ensure no real secrets are committed."
  exit 1
fi

echo "✅ Pre-commit checks passed."
